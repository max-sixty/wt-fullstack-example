# Worktrunk Full-Stack Example
#
# Creates a tmux session with 4 panes, unique ports, and conda activation.
# See README.md for details.

[post-create]
# Generate .env files with worktree-specific ports
env = """
cat > .env << EOF
BACKEND_PORT={{ ('backend-' ~ branch) | hash_port }}
FRONTEND_PORT={{ ('frontend-' ~ branch) | hash_port }}
EOF
cat > .env.backend << EOF
PORT={{ ('backend-' ~ branch) | hash_port }}
CORS_ORIGINS=http://localhost:{{ ('frontend-' ~ branch) | hash_port }}
EOF
cat > .env.frontend << EOF
PORT={{ ('frontend-' ~ branch) | hash_port }}
VITE_API_URL=http://localhost:{{ ('backend-' ~ branch) | hash_port }}
EOF
echo "✓ .env files: backend :{{ ('backend-' ~ branch) | hash_port }}, frontend :{{ ('frontend-' ~ branch) | hash_port }}"
"""

[post-start]
# Create tmux session: shell | claude / backend | frontend
tmux = """
S="{{ branch | sanitize }}"
W="{{ worktree_path }}"
tmux kill-session -t "$S" 2>/dev/null || true
tmux new-session -d -s "$S" -c "$W" -n dev
tmux split-window -h -t "$S:dev" -c "$W"
tmux split-window -v -t "$S:dev.0" -c "$W"
tmux split-window -v -t "$S:dev.2" -c "$W"

# Pane 0: Shell
tmux send-keys -t "$S:dev.0" 'source scripts/pane-init.sh' Enter
# Pane 1: Backend server
tmux send-keys -t "$S:dev.1" 'source scripts/pane-init.sh && set -a && source .env.backend && set +a && cd backend && python -m http.server -b localhost $PORT' Enter
# Pane 2: Claude Code
tmux send-keys -t "$S:dev.2" 'source scripts/pane-init.sh && claude' Enter
# Pane 3: Frontend server
tmux send-keys -t "$S:dev.3" 'source scripts/pane-init.sh && set -a && source .env.frontend && set +a && cd frontend && python -m http.server -b localhost $PORT' Enter

tmux select-pane -t "$S:dev.0"
echo "✓ Tmux session '$S' — attach with: tmux attach -t $S"
"""

[pre-remove]
# The rm -f isn't strictly needed — .env files are gitignored so they won't
# block removal. But tmux kill-session is needed to stop the running servers.
cleanup = """
rm -f .env .env.backend .env.frontend 2>/dev/null || true
tmux kill-session -t "{{ branch | sanitize }}" 2>/dev/null || true
"""

[list]
url = "http://localhost:{{ ('frontend-' ~ branch) | hash_port }}"
